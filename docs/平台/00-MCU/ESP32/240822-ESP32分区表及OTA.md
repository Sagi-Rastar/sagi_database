# 240822-ESP32分区表及 OTA

## 1 分区表

>分区表官方文档： https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/partition-tables.html

分区表中的每个条目都包括以下几个部分：Name（标签）、Type（app、data 等）、SubType 以及在 flash 中的偏移量（分区的加载地址）。

![](240822-ESP32分区表及OTA/image-20240822144319641.png)
>内置分区表举例

创建自定义分区表：

![](240822-ESP32分区表及OTA/image-20240822144526358.png)

- Name 字段不能超过 16 个字节
- Type 字段可以指定为 `app` 或 `data` ；这是常用的两个枚举类型，具体完整的存储数据格式可以参考 [`esp_partition_type_t`]( https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/storage/partition.html#_CPPv420esp_partition_type_t "esp_partition_type_t")
- SubType 字段仅规定 `app` 和 `data` 字段的含义，查阅 [`esp_partition_subtype_t`]( https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/storage/partition.html#_CPPv423esp_partition_subtype_t "esp_partition_subtype_t")以了解完整的子类型列表
	- Type: app
		- `factory`：
		- `ota_x`：若使用 OTA 的时候至少应当有两个 OTA 应用程序分区；最大可以有 0-15
		- `test`：测试用，预留的子类型；用于工厂测试流程；如果没有其他有效的 app 分区也可以作为备选启动分区进行使用。
	- Type: data
		- `ota`：指定打开的 OTA 应用程序；大小需要设定为 `0x2000` ，容量为两个 flash 扇区的大小，这是为了放置写入的时候电源故障引发问题，两个扇区单独擦除、写入匹配数据，若存在不一致，则用计数器字段判定哪个扇区为最新数据。；参考 [OTA 文档](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/system/ota.html) 
		- `phy`：用于存放 PHY 初始化数据；从而保证可以为每个设备配置 PHY
		- `nvs`：非易失性存储；官方建议至少分配 `0x3000` 个字节的空间，如果使用其 API 存储大量数据，默认是 `0x6000` 个字节
		- `nvs_keys`：nvs 的密钥分区

>![](240822-ESP32分区表及OTA/image-20240822153258586.png)

实际烧写的分区表不是 csv 文件本身，需要转换为二进制文件。如果在 menuconfig 中设置了分区表 csv 文件的名称的话，利用 idf. py 构建项目将会自动转换。

## 2 OTA 参考

>参考博客： https://blog.csdn.net/qq_36347513/article/details/117819717?spm=1001.2014.3001.5501

>官方 API 参考： https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/system/ota.html

OTA 详细过程：

![](240822-ESP32分区表及OTA/image-20240822155139855.png)

**原生 API 的 demo 流程解析：**

![](240822-ESP32分区表及OTA/image-20240822170040282.png)

### 2.1 创建 HTTP 服务器

#### 2.1.1 Python 方式 

```bash
python -m http.server --bind 192.168.61.67 8070
```

在 build 文件夹下运行上述指令，将会生成一个本地服务器，该服务器下对应 build 文件夹下的所有内容；

#### 2.1.2 HFS 方式

一个可视化工具，大概长这样：

![](240822-ESP32分区表及OTA/image-20240822170400118.png)


