
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://sagidb.github.io/_Embedded/240619-%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91/">
      
      
        <link rel="prev" href="../240618-SNTP%20%E8%8E%B7%E5%8F%96%E6%97%B6%E9%97%B4%E3%80%81AES%20%E5%8A%A0%E5%AF%86/">
      
      
        <link rel="next" href="../240625-%E5%8D%A1%E5%85%B3%E7%B3%BB%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.31">
    
    
      
        <title>240619-蓝牙开发 - Sagi's database</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeline.css">
    
      <link rel="stylesheet" href="../../css/custom.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap">
    
      <link rel="stylesheet" href="https://cdn.tonycrane.cc/jbmono/jetbrainsmono.css">
    
      <link rel="stylesheet" href="../../css/heti.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#240619-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Sagi&#39;s database" class="md-header__button md-logo" aria-label="Sagi's database" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sagi's database
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              240619-蓝牙开发
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>
    
  
  欢迎

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../_CS/240716-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="md-tabs__link">
          
  
    
  
   CS

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
   Embedded

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../_Web/240823-HTTPS%E4%B8%8EOpenSSL/" class="md-tabs__link">
          
  
    
  
   Web

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../_%E7%A7%8B%E6%8B%9B/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%B5%B7%E8%8D%89%E6%A8%A1%E6%9D%BF/" class="md-tabs__link">
          
  
    
  
   秋招

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Sagi&#39;s database" class="md-nav__button md-logo" aria-label="Sagi's database" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Sagi's database
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5Z"/></svg>
  
  <span class="md-ellipsis">
    欢迎
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
     CS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
             CS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_CS/240716-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240716-内存管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_CS/240829-python%E6%93%8D%E4%BD%9C%E4%B8%B2%E5%8F%A3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240829-python 操作串口
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_CS/240905-C%E8%AF%AD%E8%A8%80%E8%AF%AD%E6%B3%95%E7%89%B9%E6%80%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240905-C语言语法特性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_CS/240918-C%E8%AF%AD%E8%A8%80%E5%85%AB%E8%82%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240918-C 语言八股
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_CS/240923-C%E8%AF%AD%E8%A8%80%E8%87%AA%E7%BC%96%E5%B0%8F%E6%A8%A1%E5%9D%97%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240923-C语言自编小模块笔记
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
     Embedded
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
             Embedded
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240603-%E9%9F%A6%E6%A0%B9%E5%8D%8F%E8%AE%AEWiegand/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240603-韦根协议 Wiegand
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240615-smartconfig%E9%85%8D%E7%BD%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240615-smartconfig 配网
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240617-IDF%20%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%EF%BC%8C%E5%8F%8A%20wifi%20%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240617-IDF 的事件循环，及 wifi 运行流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240618-SNTP%20%E8%8E%B7%E5%8F%96%E6%97%B6%E9%97%B4%E3%80%81AES%20%E5%8A%A0%E5%AF%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240618-SNTP 获取时间、AES 加密
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    240619-蓝牙开发
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    240619-蓝牙开发
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1 基础概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 基础概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-gatt" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 GATT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-profile" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-service" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-characteristic" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Characteristic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-uuid" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 UUID
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ble_gatt_server_service_table" class="md-nav__link">
    <span class="md-ellipsis">
      2 基于../ble_gatt_server_service_table 例程的二次开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 基于../ble_gatt_server_service_table 例程的二次开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-app-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 APP Profiles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 设置广播数据
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-gap-gap_event_handler" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 GAP 事件（gap_event_handler）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-gatt" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 GATT 事件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 服务表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-attribute-table-services-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 通过属性表（Attribute Table）创建 Services 和 Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-service" class="md-nav__link">
    <span class="md-ellipsis">
      2.7 添加新的 Service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-walkthrough" class="md-nav__link">
    <span class="md-ellipsis">
      3 门禁控制器中的蓝牙任务 Walkthrough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 门禁控制器中的蓝牙任务 Walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-esp_gatts_reg_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 ESP_GATTS_REG_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-esp_gatts_creat_attr_tab_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 ESP_GATTS_CREAT_ATTR_TAB_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-esp_gatts_start_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 ESP_GATTS_START_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-esp_gatts_write_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 ESP_GATTS_WRITE_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 业务函数一般接口
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240625-%E5%8D%A1%E5%85%B3%E7%B3%BB%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240625-卡关系存储设计
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240626-BM8563%20%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D%EF%BC%8CIDF-I2C%20%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240626-BM8563 驱动移植，IDF-I2C 笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240719-LEDPWM%E5%8F%8A%E5%B8%B8%E7%94%A8%E6%8C%87%E7%A4%BA%E5%87%BD%E6%95%B0%E5%B0%81%E8%A3%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240719-LEDPWM及常用指示函数封装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240814-CubeMX%2BFreeRTOS%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240814-CubeMX+FreeRTOS开发笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240818-%E8%93%9D%E7%89%99%E9%85%8D%E7%BD%91%E4%BB%A5%E5%8F%8AsoftAP%E6%96%B9%E5%BC%8F%E9%85%8D%E7%BD%91%E6%8E%A2%E7%B4%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240818-蓝牙配网以及 softAP 方式配网探索
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240820-SolidWorks%E5%BC%80%E8%9E%BA%E7%BA%B9%E5%AD%94/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240820-SolidWorks开螺纹孔
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240822-ESP32%E5%88%86%E5%8C%BA%E8%A1%A8%E5%8F%8AOTA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240822-ESP32分区表及 OTA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240830-%E5%90%84%E7%A7%8D%E9%80%9A%E7%94%A8%E4%B8%B2%E5%8F%A3%E6%80%BB%E7%BA%BF%E6%A0%87%E5%87%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240830-各种通用串口总线标准
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240830-%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E5%85%89%E6%BA%90%E6%8E%A7%E5%88%B6%E5%99%A8%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240830-缺陷检测光源控制器开发笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240905-%E6%9B%B4%E6%96%B0storage%E4%BB%A5%E5%8F%8Amqtt%E6%A8%A1%E5%9D%97%E9%83%A8%E5%88%86%EF%BC%8C%E9%80%90%E6%AD%A5%E5%AE%9E%E7%8E%B0%E7%A7%81%E6%9C%89json%E5%8D%8F%E8%AE%AE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240905-更新 Storage 以及 MQTT 模块部分，逐步实现私有 json 协议
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240923-STM32%20%E6%9D%82%E9%A1%B9%E7%9F%A5%E8%AF%86%E7%82%B9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240923-STM32 杂项知识点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../240924-%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE%E6%80%BB%E7%BB%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    240924-通讯协议总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ESP32%E9%A1%B9%E7%9B%AE%E6%B1%87%E6%80%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ESP32项目汇总
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
     Web
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
             Web
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_Web/240823-HTTPS%E4%B8%8EOpenSSL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPS 与 OpenSSL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
     秋招
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
             秋招
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_%E7%A7%8B%E6%8B%9B/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%B5%B7%E8%8D%89%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常见问题起草模板
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_%E7%A7%8B%E6%8B%9B/%E7%A7%8B%E6%8B%9B%E8%BF%9B%E5%BA%A6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    秋招进度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_%E7%A7%8B%E6%8B%9B/%E9%A1%B9%E7%9B%AE%E6%95%B4%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目整理
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1 基础概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 基础概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-gatt" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 GATT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-profile" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-service" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Service
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-characteristic" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Characteristic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-uuid" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 UUID
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-ble_gatt_server_service_table" class="md-nav__link">
    <span class="md-ellipsis">
      2 基于../ble_gatt_server_service_table 例程的二次开发
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 基于../ble_gatt_server_service_table 例程的二次开发">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-app-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 APP Profiles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 设置广播数据
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-gap-gap_event_handler" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 GAP 事件（gap_event_handler）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-gatt" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 GATT 事件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 服务表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-attribute-table-services-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 通过属性表（Attribute Table）创建 Services 和 Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-service" class="md-nav__link">
    <span class="md-ellipsis">
      2.7 添加新的 Service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-walkthrough" class="md-nav__link">
    <span class="md-ellipsis">
      3 门禁控制器中的蓝牙任务 Walkthrough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 门禁控制器中的蓝牙任务 Walkthrough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-esp_gatts_reg_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 ESP_GATTS_REG_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-esp_gatts_creat_attr_tab_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 ESP_GATTS_CREAT_ATTR_TAB_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-esp_gatts_start_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 ESP_GATTS_START_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-esp_gatts_write_evt" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 ESP_GATTS_WRITE_EVT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 业务函数一般接口
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="240619-">240619-蓝牙开发<a class="headerlink" href="#240619-" title="Permanent link">&para;</a></h1>
<p>ESP32-S3 的 ESP-Bluedroid 仅支持低功耗蓝牙, 不支持经典蓝牙</p>
<h2 id="1">1 基础概念<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>参考博客： <a href="https://blog.csdn.net/qq_36347513/article/details/118567281">https://blog.csdn.net/qq_36347513/article/details/118567281</a></p>
</blockquote>
<h3 id="11-gatt">1.1 GATT<a class="headerlink" href="#11-gatt" title="Permanent link">&para;</a></h3>
<p>基于 Attribute Protocal(属性协议)定义的一个 service(服务)框架。这个框架定义了 Services 以及它们的 Characteristics 的格式和规程。规程就是定义了包括发现、读、写、通知、指示以及配置广播的 characteristics。</p>
<p>框架还定义了在蓝牙通信中的两个角色, 客户端以及服务器，一般终端设备的 ble 工作在 server 模式。</p>
<p>当两个设备建立了连接后即表示 GAP 协议管理的广播过程已经结束。</p>
<h3 id="12-profile">1.2 Profile<a class="headerlink" href="#12-profile" title="Permanent link">&para;</a></h3>
<p>一般理解做规范, 分成标准以及非标准， 或者公有以及私有规范。</p>
<h3 id="13-service">1.3 Service<a class="headerlink" href="#13-service" title="Permanent link">&para;</a></h3>
<p>理解成服务，存在于 Profile 下。每个 Service 包含有若干个 Characteristic，即特征。</p>
<p>每个特征可以理解为一个标签，是实际想要传输的信息载体。</p>
<h3 id="14-characteristic">1.4 Characteristic<a class="headerlink" href="#14-characteristic" title="Permanent link">&para;</a></h3>
<p>若特征值支持通知以及指示功能，则该特征值需要实现一个额外的 ATT——CCCD（Client Characteristic Configuration Descriptor）</p>
<h3 id="15-uuid">1.5 UUID<a class="headerlink" href="#15-uuid" title="Permanent link">&para;</a></h3>
<p>所有的服务以及特征都需要有唯一一个 UUID 来标识。</p>
<h2 id="2-ble_gatt_server_service_table">2 基于../ble_gatt_server_service_table 例程的二次开发<a class="headerlink" href="#2-ble_gatt_server_service_table" title="Permanent link">&para;</a></h2>
<blockquote>
<p>官方 GATT_SERVER_API 参考: <a href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/bluetooth/esp_gatts.html">https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/bluetooth/esp_gatts.html</a></p>
<p>例程源码: <a href="https://github.com/espressif/esp-idf/tree/d7ca8b94/examples/bluetooth/bluedroid/ble/gatt_server_service_table">https://github.com/espressif/esp-idf/tree/d7ca8b94/examples/bluetooth/bluedroid/ble/gatt_server_service_table</a></p>
</blockquote>
<h3 id="21-app-profiles">2.1 APP Profiles<a class="headerlink" href="#21-app-profiles" title="Permanent link">&para;</a></h3>
<p>demo 中只定义了一个用于测量心率的 Profile，开头的宏定义如下：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define PROFILE_NUM 1</span>
<span class="cp">#define PROFILE_APP_IDX 0</span>
<span class="cp">#define ESP_APP_ID 0x55</span>
</code></pre></div>
<p>其中 ESP_APP_ID 是由用户定义的一个 ID，用于区别不同的 profile。</p>
<p>在 IDF 中 profile 被保存在一个类型为 <code>gatts_profile_inst</code> 的数组中，并需要指定 <code>gatts_cb</code> 以及 <code>gatts_if</code> ，如下所示：</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gatts_profile_inst</span><span class="w"> </span><span class="n">heart_rate_profile_tab</span><span class="p">[</span><span class="n">HEART_PROFILE_NUM</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">HEART_PROFILE_APP_IDX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">gatts_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gatts_profile_event_handler</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">gatts_if</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP_GATT_IF_NONE</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="22">2.2 设置广播数据<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<p>注册应用程序事件是在程序生命周期中触发的第一个事件。</p>
<p>此示例使用此事件在注册概要文件事件处理程序时配置广播参数。用于实现此目的的函数有：</p>
<ul>
<li><code>esp_ble_gap_set_device_name()</code>: 用于设置被广播的设备名称。</li>
<li><code>esp_ble_gap_config_adv_data()</code>: 用于配置标准广播数据。</li>
</ul>
<p>后者接收一个指向 <code>esp_ble_adv_data_t</code> 类型结构体的指针，该结构体定义了广播数据包的具体负载。此处需要注意，一般广播数据包的具体负载不能超过 31 个字节，否则将会被堆栈截断后面的消息。</p>
<p>一般为了解决这个问题，较长的参数可以存储在扫描响应中。如果要采取扫描响应的话，可以新建一个 <code>esp_ble_adv_data_t</code> 类型的结构体，并将 <code>set_scan_rsp</code> 设置为 <code>true</code> 后使用相同的函数进行配置。</p>
<p>以上的操作被放在 <code>gatts_profile_event_handler</code> 这个函数中的 <code>ESP_GATTS_REG_EVT</code> 事件中，一旦设置完广播数据之后，将会触发 <code>ESP_GAP_BLE_ADV_DATA_SET_COMPLETE_EVT</code> 事件，并交由 <code>gap_event_handler</code> 函数进行管理，若也设置了扫描响应，则 <code>ESP_GAP_BLE_SCAN_RSP_DATA_SET_COMPLETE_EVT</code> 事件也会被触发。</p>
<h3 id="23-gap-gap_event_handler">2.3 GAP 事件（<code>gap_event_handler</code>）<a class="headerlink" href="#23-gap-gap_event_handler" title="Permanent link">&para;</a></h3>
<p>接着上面，如果广播数据两个事件中的任意一个事件（设置广播数据或设置扫描响应完成）被触发，则会调用 <code>esp_ble_gap_start_advertising</code> 函数来开始广播，该函数需要一个 <code>esp_ble_adv_params_t</code> 类型的广播参数。</p>
<p>该参数指定了开启广播所需的各种参数，例如广播间隔、广播类型、广播信道以及广播过滤策略等：</p>
<div class="highlight"><pre><span></span><code><span class="c1">/// 广播参数</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">adv_int_min</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; 未定向和低占空比定向广播的最小广播间隔。</span>
<span class="cm">    范围：0x0020到0x4000</span>
<span class="cm">    默认值：N = 0x0800（1.28秒）</span>
<span class="cm">    时间= N * 0.625毫秒</span>
<span class="cm">    时间范围：20毫秒到10.24秒 */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">adv_int_max</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; 未定向和低占空比定向广播的最大广播间隔。</span>
<span class="cm">    范围：0x0020到0x4000</span>
<span class="cm">    默认值：N = 0x0800（1.28秒）</span>
<span class="cm">    时间= N * 0.625毫秒</span>
<span class="cm">    时间范围：20毫秒到10.24秒 */</span>
<span class="w">    </span><span class="n">esp_ble_adv_type_t</span><span class="w"> </span><span class="n">adv_type</span><span class="p">;</span><span class="w">            </span><span class="cm">/*!&lt; 广播类型 */</span>
<span class="w">    </span><span class="n">esp_ble_addr_type_t</span><span class="w"> </span><span class="n">own_addr_type</span><span class="p">;</span><span class="w">      </span><span class="cm">/*!&lt; 所有者蓝牙设备地址类型 */</span>
<span class="w">    </span><span class="n">esp_bd_addr_t</span><span class="w"> </span><span class="n">peer_addr</span><span class="p">;</span><span class="w">                </span><span class="cm">/*!&lt; 对等方设备的蓝牙设备地址 */</span>
<span class="w">    </span><span class="n">esp_ble_addr_type_t</span><span class="w"> </span><span class="n">peer_addr_type</span><span class="p">;</span><span class="w">     </span><span class="cm">/*!&lt; 对等方设备的蓝牙设备地址类型 */</span>
<span class="w">    </span><span class="n">esp_ble_adv_channel_t</span><span class="w"> </span><span class="n">channel_map</span><span class="p">;</span><span class="w">      </span><span class="cm">/*!&lt; 广播通道映射 */</span>
<span class="w">    </span><span class="n">esp_ble_adv_filter_t</span><span class="w"> </span><span class="n">adv_filter_policy</span><span class="p">;</span><span class="w"> </span><span class="cm">/*!&lt; 广播过滤策略 */</span>
<span class="p">}</span><span class="w"> </span><span class="n">esp_ble_adv_params_t</span><span class="p">;</span>
</code></pre></div>
<p>例程中配置的几个重要参数：</p>
<ul>
<li><code>adv_type</code> - <code>ADV_ IND</code> 类型，通用类型，不针对特定的中心设备，广播服务器为可连接的。</li>
<li><code>own_addr_type</code> - <code>BLE_ADDR_TYPE_PUBLIC</code> 公共地址类型</li>
<li><code>channel_map</code> - <code>ADV_CHNL_ALL</code> 使用所有通道</li>
<li><code>adv_filter_policy</code> - <code>ADV_FILTER_ALLOW_SCAN_ANY_CON_ANY</code> 允许来自任何中心设备的扫描和连接请求</li>
</ul>
<p>一旦广播成功开始后，<code>esp_ble_gap_start_advertising</code> 函数将会触发 <code>ESP_GAP_BLE_ADV_START_COMPLETE_EVT</code> 事件，例程中在这个事件中只是单纯检查广播状态，并打印消息。</p>
<h3 id="24-gatt">2.4 GATT 事件<a class="headerlink" href="#24-gatt" title="Permanent link">&para;</a></h3>
<p>应用的 <code>Profile</code> 注册操作在例程中的 <code>ble_server_task_init</code> 初始化流程中通过调用 <code>esp_ble_gatts_app_register</code> 函数实现，该函数使用一个 <code>APP ID</code> 用于区分各种应用层的回调。</p>
<p>调用 <code>esp_ble_gatts_app_register</code> 函数后， <code>ESP_GATTS_REG_EVT</code> 事件将会被触发，该事件会被 <code>gatts_event_handler</code> 函数捕获，然后将生成的 <code>gatt_if</code>（interface）接口存放在 <code>profile_tab</code> 中，也就是一开始初始化的时候设置为 <code>ESP_GATT_IF_NONE</code> 的 <code>Profile</code>。</p>
<p>本例中定义的应用程序只有一个 <code>Profile</code>，因此在将生成的接口存放过去之后，也就相当于将其转发到相应的 <code>gatts_profile_event_handler</code> 函数中，开始对这个 <code>Profile</code> 触发的事件进行处理了。</p>
<h3 id="25">2.5 服务表<a class="headerlink" href="#25" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">HRS_IDX_SVC</span><span class="p">,</span>

<span class="w">    </span><span class="n">HRS_IDX_HR_MEAS_CHAR</span><span class="p">,</span>
<span class="w">    </span><span class="n">HRS_IDX_HR_MEAS_VAL</span><span class="p">,</span>
<span class="w">    </span><span class="n">HRS_IDX_HR_MEAS_NTF_CFG</span><span class="p">,</span>

<span class="w">    </span><span class="n">HRS_IDX_BOBY_SENSOR_LOC_CHAR</span><span class="p">,</span>
<span class="w">    </span><span class="n">HRS_IDX_BOBY_SENSOR_LOC_VAL</span><span class="p">,</span>

<span class="w">    </span><span class="n">HRS_IDX_HR_CTNL_PT_CHAR</span><span class="p">,</span>
<span class="w">    </span><span class="n">HRS_IDX_HR_CTNL_PT_VAL</span><span class="p">,</span>

<span class="w">    </span><span class="n">HRS_IDX_NB</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<p>这个枚举元素定义了心率服务的一系列索引，每个服务和特征都有一个唯一的索引，这些索引用于在代码中应用特定的服务和特征。</p>
<p>通过这种方式，可以方便地管理和操作 GATT_server 的特性。</p>
<p>HRS for Heart Rate Service.</p>
<p>BTW，这个服务表中的枚举类型为自己定义的东西，例程只是给出了一个心率测量应用场景下的样例。walkthrough 文档中的代码似乎是比较早的版本了，现在的实际代码文件中给出的例子是这样的，通用性更强一点：</p>
<div class="highlight"><pre><span></span><code><span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">IDX_SVC</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_A</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_VAL_A</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_CFG_A</span><span class="p">,</span>

<span class="w">    </span><span class="n">IDX_CHAR_B</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_VAL_B</span><span class="p">,</span>

<span class="w">    </span><span class="n">IDX_CHAR_C</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_VAL_C</span><span class="p">,</span>

<span class="w">    </span><span class="n">HRS_IDX_NB</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>
<h3 id="26-attribute-table-services-characteristics">2.6 通过属性表（Attribute Table）创建 Services 和 Characteristics<a class="headerlink" href="#26-attribute-table-services-characteristics" title="Permanent link">&para;</a></h3>
<p>注册 Services 和 Characteristics 的事件通过使用 <code>esp_ble_gatts_create_attr_tab</code> 函数来创建属性表，该函数需要一个类型为 <code>esp_gatts_attr_db_t</code> 的参数。该参数由枚举值进行索引，即上节定义的服务表，包括两个成员：</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">esp_attr_control_t</span><span class="w">      </span><span class="n">attr_control</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="n">esp_attr_desc_t</span><span class="w">         </span><span class="n">att_desc</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">esp_gatts_attr_db_t</span><span class="p">;</span>
</code></pre></div>
<p>第一个是自动响应参数，有两个可选：</p>
<ul>
<li><code>ESP_GATT_AUTO_RSP</code> - 允许 BLE 堆栈对于读取或写入事件到达时自动发送响应消息</li>
<li><code>ESP_GATT_RSP_BY_APP</code> - 使用 <code>esp_ble_gatts_send_response</code> 函数进行手动响应消息</li>
</ul>
<p>第二个是属性类型：</p>
<div class="highlight"><pre><span></span><code><span class="kt">uint16_t</span><span class="w"> </span><span class="n">uuid_length</span><span class="p">;</span><span class="w">      </span><span class="cm">/*!&lt; UUID长度 */</span>
<span class="kt">uint8_t</span><span class="w">  </span><span class="o">*</span><span class="n">uuid_p</span><span class="p">;</span><span class="w">          </span><span class="cm">/*!&lt; UUID值 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">perm</span><span class="p">;</span><span class="w">             </span><span class="cm">/*!&lt; 属性权限 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">max_length</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; 元素的最大长度 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; 元素的当前长度 */</span>
<span class="kt">uint8_t</span><span class="w">  </span><span class="o">*</span><span class="n">value</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; 元素值数组*/</span>
</code></pre></div>
<p>通过函数 <code>esp_ble_gatts_create_attr_tab</code> 创建完后将会触发 <code>ESP_GATTS_CREAT_ATTR_TAB_EVT</code> 事件，用于打印各种信息，检查创建的属性表大小是否等于 <code>HRS_IDX_NB</code> ，在检查完成之后将会将属性表的句柄复制到 <code>heart_rate_handle_table</code> 中，以便用于传递，以及用于 app 的上层来进行不同的操作。通过这些属性表的句柄，可以用于知道当前正在读取/写入哪些特征。</p>
<p>最后通过 <code>esp_ble_gatts_start_service</code> 函数开始服务。</p>
<h3 id="27-service">2.7 添加新的 Service<a class="headerlink" href="#27-service" title="Permanent link">&para;</a></h3>
<ul>
<li>宏定义处添加新 Service 实例的 ID，如：
<div class="highlight"><pre><span></span><code><span class="cp">#define SVC_INST_ID1 1</span>
</code></pre></div></li>
<li>添加新的 Service_handle_table，如：
<div class="highlight"><pre><span></span><code><span class="kt">uint16_t</span><span class="w"> </span><span class="o">&lt;</span><span class="n">srvc</span><span class="o">&gt;</span><span class="n">_handle_table</span><span class="p">[</span><span class="o">&lt;</span><span class="n">svc</span><span class="o">&gt;</span><span class="n">_IDX_NB</span><span class="p">];</span>
</code></pre></div></li>
<li>定义新的 Service 与 Characteristic 的 UUID，如：
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">&lt;</span><span class="n">srvc</span><span class="o">&gt;</span><span class="n">_SERVICE_UUID_DM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00EE</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">GATTS_CHAR_UUID_</span><span class="o">&lt;</span><span class="n">srvc</span><span class="o">&gt;</span><span class="n">_</span><span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xEE01</span><span class="p">;</span>
</code></pre></div></li>
<li>定义新的 Service database，如：
<div class="highlight"><pre><span></span><code><span class="cm">/* 特征值以及UUID名可能有出入 */</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">esp_gatts_attr_db_t</span><span class="w"> </span><span class="n">gatt_db2</span><span class="p">[</span><span class="n">DM_IDX_NB</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">IDX_SVC2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="p">{{</span><span class="n">ESP_GATT_AUTO_RSP</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">ESP_UUID_LEN_16</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">primary_service_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">ESP_GATT_PERM_READ</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">GATTS_SERVICE_UUID_DM</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">GATTS_SERVICE_UUID_DM</span><span class="p">}},</span>

<span class="w">    </span><span class="p">[</span><span class="n">IDX_CHAR_A2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="p">{{</span><span class="n">ESP_GATT_AUTO_RSP</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">ESP_UUID_LEN_16</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">character_declaration_uuid</span><span class="p">,</span><span class="w"> </span><span class="n">ESP_GATT_PERM_READ</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">CHAR_DECLARATION_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">CHAR_DECLARATION_SIZE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">char_prop_read_write_notify</span><span class="p">}},</span>

<span class="w">    </span><span class="p">[</span><span class="n">IDX_CHAR_VAL_A2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="p">{{</span><span class="n">ESP_GATT_AUTO_RSP</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="n">ESP_UUID_LEN_16</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">GATTS_CHAR_UUID_DM_A</span><span class="p">,</span><span class="w"> </span><span class="n">ESP_GATT_PERM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ESP_GATT_PERM_WRITE</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">GATTS_DEMO_CHAR_VAL_LEN_MAX</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">char_value2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">char_value2</span><span class="p">}},</span>
<span class="p">};</span>
</code></pre></div></li>
</ul>
<p><code>esp_gatts_attr_db_t</code> 的成员定义参考如下：</p>
<p><div class="highlight"><pre><span></span><code><span class="cm">/* esp_gatts_attr_db_t */</span>
<span class="n">esp_attr_control_t</span><span class="w">      </span><span class="n">attr_control</span><span class="p">;</span><span class="w"> </span>
<span class="n">esp_attr_desc_t</span><span class="w">         </span><span class="n">att_desc</span><span class="p">;</span><span class="w">  </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="cm">/* esp_attr_desc_t */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">uuid_length</span><span class="p">;</span><span class="w">      </span><span class="cm">/*!&lt; UUID长度 */</span>
<span class="kt">uint8_t</span><span class="w">  </span><span class="o">*</span><span class="n">uuid_p</span><span class="p">;</span><span class="w">          </span><span class="cm">/*!&lt; UUID值 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">perm</span><span class="p">;</span><span class="w">             </span><span class="cm">/*!&lt; 属性权限 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">max_length</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; 元素的最大长度 */</span>
<span class="kt">uint16_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; 元素的当前长度 */</span>
<span class="kt">uint8_t</span><span class="w">  </span><span class="o">*</span><span class="n">value</span><span class="p">;</span><span class="w">           </span><span class="cm">/*!&lt; 元素值数组*/</span>
</code></pre></div></p>
<p>其中一个 service 需要包含：一个主服务声明、特征值声明、特征值。</p>
<p>除此之外，如果服务属性有 Notify 属性，还需要包含一个 CCCD（客户端特征值配置描述符）。</p>
<p>以上只有特征值的 UUID 是用户自己定义的，其他三个可以参考蓝牙规范，例程中使用了如下定义：</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">primary_service_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP_GATT_UUID_PRI_SERVICE</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">character_declaration_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP_GATT_UUID_CHAR_DECLARE</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">character_client_config_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ESP_GATT_UUID_CHAR_CLIENT_CONFIG</span><span class="p">;</span>
</code></pre></div>
<p><strong>关于服务以及特征值的读写属性，注意如下逻辑：</strong></p>
<p>不管是服务声明、特征值声明还是特征值本身，都需要设置读写权限，这里的读写权限是指服务端的权限，即服务端是否允许客户端读写服务声明、特征值声明还是特征值。</p>
<p>而对于特征值本身的属性来说，需要在特征值声明中设置值以声明是否包含读写属性以及 notify/indicate 属性。</p>
<p>也就是注意区分以下两组概念：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* file: esp_gatt_defs.h */</span>
<span class="cm">/* relate to BTA_GATT_PERM_xxx in bta/bta_gatt_api.h */</span>
<span class="cm">/**</span>
<span class="cm"> * @brief Attribute permissions</span>
<span class="cm"> */</span>
<span class="cp">#define    ESP_GATT_PERM_READ                  (1 &lt;&lt; 0)   /* bit 0 -  0x0001 */    /* relate to BTA_GATT_PERM_READ in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_READ_ENCRYPTED        (1 &lt;&lt; 1)   /* bit 1 -  0x0002 */    /* relate to BTA_GATT_PERM_READ_ENCRYPTED in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_READ_ENC_MITM         (1 &lt;&lt; 2)   /* bit 2 -  0x0004 */    /* relate to BTA_GATT_PERM_READ_ENC_MITM in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE                 (1 &lt;&lt; 4)   /* bit 4 -  0x0010 */    /* relate to BTA_GATT_PERM_WRITE in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE_ENCRYPTED       (1 &lt;&lt; 5)   /* bit 5 -  0x0020 */    /* relate to BTA_GATT_PERM_WRITE_ENCRYPTED in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE_ENC_MITM        (1 &lt;&lt; 6)   /* bit 6 -  0x0040 */    /* relate to BTA_GATT_PERM_WRITE_ENC_MITM in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE_SIGNED          (1 &lt;&lt; 7)   /* bit 7 -  0x0080 */    /* relate to BTA_GATT_PERM_WRITE_SIGNED in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE_SIGNED_MITM     (1 &lt;&lt; 8)   /* bit 8 -  0x0100 */    /* relate to BTA_GATT_PERM_WRITE_SIGNED_MITM in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_PERM_READ_AUTHORIZATION    (1 &lt;&lt; 9)   /* bit 9 -  0x0200 */</span>
<span class="cp">#define    ESP_GATT_PERM_WRITE_AUTHORIZATION   (1 &lt;&lt; 10)  /* bit 10 - 0x0400 */</span>
<span class="cp">#define    ESP_GATT_PERM_ENCRYPT_KEY_SIZE(keysize)     (((keysize - 6) &amp; 0xF) &lt;&lt; 12)    /* bit 12:15 - 0xF000 */</span>
<span class="n">typedef</span><span class="w"> </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">esp_gatt_perm_t</span><span class="p">;</span>

<span class="cm">/* relate to BTA_GATT_CHAR_PROP_BIT_xxx in bta/bta_gatt_api.h */</span>
<span class="cm">/* definition of characteristic properties */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_BROADCAST    (1 &lt;&lt; 0)       /* 0x01 */    /* relate to BTA_GATT_CHAR_PROP_BIT_BROADCAST in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_READ         (1 &lt;&lt; 1)       /* 0x02 */    /* relate to BTA_GATT_CHAR_PROP_BIT_READ in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_WRITE_NR     (1 &lt;&lt; 2)       /* 0x04 */    /* relate to BTA_GATT_CHAR_PROP_BIT_WRITE_NR in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_WRITE        (1 &lt;&lt; 3)       /* 0x08 */    /* relate to BTA_GATT_CHAR_PROP_BIT_WRITE in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_NOTIFY       (1 &lt;&lt; 4)       /* 0x10 */    /* relate to BTA_GATT_CHAR_PROP_BIT_NOTIFY in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_INDICATE     (1 &lt;&lt; 5)       /* 0x20 */    /* relate to BTA_GATT_CHAR_PROP_BIT_INDICATE in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_AUTH         (1 &lt;&lt; 6)       /* 0x40 */    /* relate to BTA_GATT_CHAR_PROP_BIT_AUTH in bta/bta_gatt_api.h */</span>
<span class="cp">#define    ESP_GATT_CHAR_PROP_BIT_EXT_PROP     (1 &lt;&lt; 7)       /* 0x80 */    /* relate to BTA_GATT_CHAR_PROP_BIT_EXT_PROP in bta/bta_gatt_api.h */</span>
<span class="n">typedef</span><span class="w"> </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">esp_gatt_char_prop_t</span><span class="p">;</span>
</code></pre></div>
<ul>
<li>于头文件中定义新的属性表，用于给上述第二点的 handle_table 索引，以便后续开发中读写某 Service 的某特征值，如：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cm">/* 设备管理相关service表 */</span>
<span class="k">enum</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">IDX_SVC2</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_A2</span><span class="p">,</span>
<span class="w">    </span><span class="n">IDX_CHAR_VAL_A2</span><span class="p">,</span>

<span class="w">    </span><span class="n">DM_IDX_NB</span><span class="p">,</span>

<span class="p">};</span>
</code></pre></div>
<ul>
<li>修改 <code>gatts_profile_event_handler</code> 中对于新建 database 的逻辑，主要思路为**创建一个启动一个**，关键修改部分如下:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cm">/* ESP_GATTS_REG_EVT 事件分支 */</span>
<span class="n">esp_err_t</span><span class="w"> </span><span class="n">create_attr_ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp_ble_gatts_create_attr_tab</span><span class="p">(</span><span class="n">gatt_db</span><span class="p">,</span><span class="w"> </span><span class="n">gatts_if</span><span class="p">,</span><span class="w"> </span><span class="n">LOCK_IDX_NB</span><span class="p">,</span><span class="w"> </span><span class="n">SVC_INST_ID</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">create_attr_ret</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attr table failed, error code = %x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">create_attr_ret</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>首先在 <code>ESP_GATTS_REG_EVT</code> 事件时创建第一个 database，该事件创建成功后，将会触发 <code>ESP_GATTS_CREAT_ATTR_TAB_EVT</code> 事件，此时再创建第二个 database，如下：</p>
<blockquote>
<p><code>ESP_GATTS_REG_EVT</code> 被最开始的 <code>esp_ble_gatts_app_register</code> 函数触发</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="cm">/* ESP_GATTS_CREAT_ATTR_TAB_EVT 事件分支*/</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">create_tab1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_GATT_OK</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table failed, error code=0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LOCK_IDX_NB</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table abnormally, num_handle (%d) \</span>
<span class="s">                doesn&#39;t equal to LOCK_IDX_NB(%d)&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="p">,</span><span class="w"> </span><span class="n">LOCK_IDX_NB</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table successfully, the number handle = %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">lock_handle_table</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">handles</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">lock_handle_table</span><span class="p">));</span>
<span class="w">        </span><span class="n">esp_ble_gatts_start_service</span><span class="p">(</span><span class="n">lock_handle_table</span><span class="p">[</span><span class="n">IDX_SVC</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ESP_GATT_OK</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table failed, error code=0x%x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">DM_IDX_NB</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table abnormally, num_handle (%d) \</span>
<span class="s">                    doesn&#39;t equal to HRS_IDX_NB(%d)&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="p">,</span><span class="w"> </span><span class="n">DM_IDX_NB</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attribute table successfully, the number handle = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">num_handle</span><span class="p">);</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">device_manage_handle_table</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">add_attr_tab</span><span class="p">.</span><span class="n">handles</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">device_manage_handle_table</span><span class="p">));</span>
<span class="w">        </span><span class="n">esp_ble_gatts_start_service</span><span class="p">(</span><span class="n">device_manage_handle_table</span><span class="p">[</span><span class="n">IDX_SVC2</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="k">break</span><span class="p">;</span>
</code></pre></div>
<p>相较于原始例程，此处添加了一个 <code>create_tab1</code> 的标志位，用于判断是否已经创建了第一个 database，如果没有则创建第一个，如果已经创建了，则创建第二个，以后有多个服务则以此类推。</p>
<p>在检查完创建的属性表大小是否等于 <code>&lt;srvc&gt;_IDX_NB</code> 之后，将会将属性表的句柄复制到 <code>&lt;srvc&gt;_handle_table</code> 中，并调用 <code>esp_ble_gatts_start_service</code> 函数开始服务，触发 <code>ESP_GATTS_START_EVT</code> 事件：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* ESP_GATTS_START_EVT 事件分支*/</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">create_tab1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SERVICE_START_EVT1, status %d, service_handle %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">service_handle</span><span class="p">);</span>
<span class="w">    </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">creat_attr_ret1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp_ble_gatts_create_attr_tab</span><span class="p">(</span><span class="n">gatt_db2</span><span class="p">,</span><span class="w"> </span><span class="n">gatts_if</span><span class="p">,</span><span class="w"> </span><span class="n">DM_IDX_NB</span><span class="p">,</span><span class="w"> </span><span class="n">SVC_INST_ID1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">creat_attr_ret1</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ESP_LOGE</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create attr table2 failed, error code = %x&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">creat_attr_ret1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">create_tab1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ESP_LOGI</span><span class="p">(</span><span class="n">GATTS_TABLE_TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SERVICE_START_EVT2, status %d, service_handle %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">service_handle</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">break</span><span class="p">;</span>
</code></pre></div>
<p>在该事件中因为开始服务成功后事件才会被触发，因此创建好第一个 database 后则可以开始创建第二个 database，则调用 <code>esp_ble_gatts_create_attr_tab</code> 函数继续创建第二个 database，以此类推。</p>
<h2 id="3-walkthrough">3 门禁控制器中的蓝牙任务 Walkthrough<a class="headerlink" href="#3-walkthrough" title="Permanent link">&para;</a></h2>
<p>首先调用 <code>ble_server_task_init</code> 函数用于初始化蓝牙控制器，蓝牙协议栈，注册 GATT 回调函数以及 GAP 回调函数，设置 MTU，并注册 profile <code>esp_ble_gatts_app_register</code>，注册 profile 将会触发事件 <code>ESP_GATTS_REG_EVT</code></p>
<blockquote>
<p>回调函数：其中 GATT 回调函数以及 GAP 回调函数用于处理蓝牙栈所有可能发生的情况，来达到 FSM 的效果</p>
<p>MTU（最大传输单元）：通过设置 MTU 的值限制 PDU（协议数据单元）最大能够交换的数据量</p>
</blockquote>
<p><code>gap_event_handler</code> 用于处理 GAP 中的事件，本次不太需要关心</p>
<p><code>gatts_event_handler</code> 接收来自协议栈中的 GATTS 事件，分发给不同的 Profile，由于本次系统设计只使用了一个 Profile ，因此相当于将事件直接传递给这唯一的 Profile</p>
<p><code>gatts_profile_event_handler</code> 是实际处理各个 GATT 操作的状态机，所有有关于对 Service 和 Characteristic 的操作都在此处进行，下面针对该状态机做一个简要概述：</p>
<h3 id="31-esp_gatts_reg_evt">3.1 <code>ESP_GATTS_REG_EVT</code><a class="headerlink" href="#31-esp_gatts_reg_evt" title="Permanent link">&para;</a></h3>
<p>在该事件中设置设备名称并配置 gap 广播数据包之后，开始创建第一个服务的属性表，通过调用该函数进行创建：<code>esp_ble_gatts_create_attr_tab</code> </p>
<p>调用该函数之后将会触发 <code>ESP_GATTS_CREAT_ATTR_TAB_EVT</code> 事件</p>
<h3 id="32-esp_gatts_creat_attr_tab_evt">3.2 <code>ESP_GATTS_CREAT_ATTR_TAB_EVT</code><a class="headerlink" href="#32-esp_gatts_creat_attr_tab_evt" title="Permanent link">&para;</a></h3>
<p>如果属性表创建成功的话，事件所携带的参数将会返回一个属性表的句柄，以下是该事件下的 param 结构体：
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gatts_add_attr_tab_evt_param</span><span class="p">{</span>
<span class="w">    </span><span class="n">esp_gatt_status_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; Operation status */</span>
<span class="w">    </span><span class="n">esp_bt_uuid_t</span><span class="w"> </span><span class="n">svc_uuid</span><span class="p">;</span><span class="w">         </span><span class="cm">/*!&lt; Service uuid type */</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">svc_inst_id</span><span class="p">;</span><span class="w">            </span><span class="cm">/*!&lt; Service id */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">num_handle</span><span class="p">;</span><span class="w">            </span><span class="cm">/*!&lt; The number of the attribute handle to be added to the gatts database */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">handles</span><span class="p">;</span><span class="w">              </span><span class="cm">/*!&lt; The number to the handles */</span>
<span class="p">}</span><span class="w"> </span><span class="n">add_attr_tab</span><span class="p">;</span><span class="w">                     </span><span class="cm">/*!&lt; Gatt server callback param of ESP_GATTS_CREAT_ATTR_TAB_EVT */</span>
</code></pre></div></p>
<p>在该事件内通过先前维护的一个全局布尔类型变量判断此时创建的是第几个属性表</p>
<p>之后将所有该属性表中的所有特征值句柄赋值给对应的句柄列表，方便后续统一管理某一个特征值的操作函数</p>
<p>最后调用 <code>esp_ble_gatts_start_service</code> 启动服务，启动完成后将会触发 <code>ESP_GATTS_START_EVT</code> 
事件</p>
<h3 id="33-esp_gatts_start_evt">3.3 <code>ESP_GATTS_START_EVT</code><a class="headerlink" href="#33-esp_gatts_start_evt" title="Permanent link">&para;</a></h3>
<p>该事件下的 param 结构体：
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gatts_start_evt_param</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">esp_gatt_status_t</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">       </span><span class="cm">/*!&lt; Operation status */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">service_handle</span><span class="p">;</span><span class="w">        </span><span class="cm">/*!&lt; Service attribute handle */</span>
<span class="p">}</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w">                            </span><span class="cm">/*!&lt; Gatt server callback param of ESP_GATTS_START_EVT */</span>
</code></pre></div></p>
<p>同样，根据全局维护的全局布尔类型变量判断是否进行下一个属性表的创建，如果有多个属性表就以此类推，完成一个属性表的创建就将对应的变量置 TRUE</p>
<h3 id="34-esp_gatts_write_evt">3.4 <code>ESP_GATTS_WRITE_EVT</code><a class="headerlink" href="#34-esp_gatts_write_evt" title="Permanent link">&para;</a></h3>
<p>该事件在发生 GATT 写操作的时候被触发，param 如下：
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">gatts_write_evt_param</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">conn_id</span><span class="p">;</span><span class="w">               </span><span class="cm">/*!&lt; Connection id */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">trans_id</span><span class="p">;</span><span class="w">              </span><span class="cm">/*!&lt; Transfer id */</span>
<span class="w">    </span><span class="n">esp_bd_addr_t</span><span class="w"> </span><span class="n">bda</span><span class="p">;</span><span class="w">              </span><span class="cm">/*!&lt; The bluetooth device address which been written */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w">                </span><span class="cm">/*!&lt; The attribute handle */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w">                </span><span class="cm">/*!&lt; Offset of the value, if the value is too long */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_rsp</span><span class="p">;</span><span class="w">                  </span><span class="cm">/*!&lt; The write operation need to do response */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is_prep</span><span class="p">;</span><span class="w">                   </span><span class="cm">/*!&lt; This write operation is prepare write */</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w">                   </span><span class="cm">/*!&lt; The write attribute value length */</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span><span class="w">                 </span><span class="cm">/*!&lt; The write attribute value */</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">write</span><span class="p">;</span><span class="w">                            </span><span class="cm">/*!&lt; Gatt server callback param of ESP_GATTS_WRITE_EVT */</span>
</code></pre></div></p>
<p>本次 gatts 中实现了一个函数 <code>write_event_handler</code> ，接收三个参数，分别是：</p>
<ul>
<li>操作的特征值句柄</li>
<li>数据长度</li>
<li>写入数据的指针</li>
</ul>
<p>该函数将会遍历预先设定好的查找表，匹配操作特征值的对应业务函数</p>
<h3 id="35">3.5 业务函数一般接口<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<p>由于提前规范了双方的加密协议，一般客户端写入的特征值都是统一的加密帧数据包，先要对数据包进行解密，通过先前提及的 <code>data_frame_unpacking</code> 和 <code>data_frame_packing</code> 函数可以进行处理</p>
<p>函数一般接受来自前级传递来的特征值句柄、数据长度、数据的指针</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.indexes", "navigation.path", "navigation.tabs", "navigation.top", "content.code.annotate", "navigation.tracking", "header.autohide"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../js/heti.js"></script>
      
    
  </body>
</html>